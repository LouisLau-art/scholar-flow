openapi: 3.0.0
info:
  title: 超级用户管理后台 API
  description: ScholarFlow系统超级管理员用户管理功能API
  version: 1.0.0
  contact:
    name: ScholarFlow开发团队
    email: dev@scholarflow.example.com

servers:
  - url: http://localhost:8000
    description: 开发服务器
  - url: https://api.scholarflow.example.com
    description: 生产服务器

tags:
  - name: AdminUsers
    description: 超级管理员用户管理操作

paths:
  /api/v1/admin/users:
    get:
      tags:
        - AdminUsers
      summary: 获取用户列表
      description: 获取所有注册用户列表，支持分页、搜索和筛选
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: 页码（从1开始）
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: 每页记录数
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: search
          in: query
          description: 搜索关键词（邮箱或姓名前缀匹配）
          required: false
          schema:
            type: string
            minLength: 2
            maxLength: 100
        - name: role
          in: query
          description: 按角色筛选
          required: false
          schema:
            type: string
            enum: [author, editor, reviewer, admin]
        - name: sort_by
          in: query
          description: 排序字段
          required: false
          schema:
            type: string
            enum: [created_at, name, email]
            default: created_at
        - name: sort_order
          in: query
          description: 排序方向
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: 用户列表获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非超级管理员）
        '500':
          description: 服务器内部错误

    post:
      tags:
        - AdminUsers
      summary: 创建内部编辑账号
      description: 超级管理员直接创建已验证的内部编辑账号
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: 用户创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: 请求参数无效
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非超级管理员）
        '409':
          description: 邮箱已存在
        '500':
          description: 服务器内部错误

  /api/v1/admin/users/{user_id}:
    get:
      tags:
        - AdminUsers
      summary: 获取用户详情
      description: 获取指定用户的详细信息
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: 用户ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 用户详情获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetailResponse'
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非超级管理员）
        '404':
          description: 用户不存在
        '500':
          description: 服务器内部错误

  /api/v1/admin/users/{user_id}/role:
    put:
      tags:
        - AdminUsers
      summary: 修改用户角色
      description: 修改指定用户的角色，需要提供变更原因
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: 用户ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: 角色修改成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleChangeResponse'
        '400':
          description: 请求参数无效（如变更原因太短）
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非超级管理员）或禁止操作（如修改自己角色）
        '404':
          description: 用户不存在
        '409':
          description: 角色未变更（新旧角色相同）
        '500':
          description: 服务器内部错误

  /api/v1/admin/users/{user_id}/role-changes:
    get:
      tags:
        - AdminUsers
      summary: 获取用户角色变更历史
      description: 获取指定用户的角色变更记录
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: 用户ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: 返回记录数限制
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        '200':
          description: 角色变更历史获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleChangeListResponse'
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非超级管理员）
        '404':
          description: 用户不存在
        '500':
          description: 服务器内部错误

  /api/v1/admin/users/invite-reviewer:
    post:
      tags:
        - AdminUsers
      summary: 邀请临时审稿人
      description: 为不存在的邮箱创建临时审稿人账号并发送邀请
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteReviewerRequest'
      responses:
        '201':
          description: 临时审稿人邀请发送成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteReviewerResponse'
        '400':
          description: 请求参数无效
        '401':
          description: 未授权或令牌无效
        '403':
          description: 权限不足（非编辑或超级管理员）
        '409':
          description: 邮箱已存在（用户已注册）
        '500':
          description: 服务器内部错误

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT令牌

  schemas:
    User:
      type: object
      required:
        - id
        - email
        - name
        - role
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: 用户ID
        email:
          type: string
          format: email
          description: 用户邮箱
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 用户姓名
        role:
          type: string
          enum: [author, editor, reviewer, admin]
          description: 用户角色
        created_at:
          type: string
          format: date-time
          description: 注册时间
        last_sign_in_at:
          type: string
          format: date-time
          description: 最后登录时间
          nullable: true

    UserListResponse:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        pagination:
          $ref: '#/components/schemas/Pagination'

    UserDetailResponse:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            role_changes:
              type: array
              items:
                $ref: '#/components/schemas/RoleChange'
              description: 最近的角色变更记录

    CreateUserRequest:
      type: object
      required:
        - email
        - name
      properties:
        email:
          type: string
          format: email
          description: 用户邮箱
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 用户姓名
        role:
          type: string
          enum: [editor]
          default: editor
          description: 用户角色（固定为editor）

    UpdateRoleRequest:
      type: object
      required:
        - new_role
        - reason
      properties:
        new_role:
          type: string
          enum: [editor, reviewer]
          description: 新角色
        reason:
          type: string
          minLength: 10
          maxLength: 500
          description: 变更原因

    RoleChange:
      type: object
      required:
        - id
        - old_role
        - new_role
        - reason
        - operator_name
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: 变更记录ID
        old_role:
          type: string
          enum: [author, editor, reviewer, admin]
          description: 原角色
        new_role:
          type: string
          enum: [author, editor, reviewer, admin]
          description: 新角色
        reason:
          type: string
          description: 变更原因
        operator_name:
          type: string
          description: 操作者姓名
        created_at:
          type: string
          format: date-time
          description: 变更时间

    RoleChangeResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
        message:
          type: string
          description: 操作结果消息
        role_change:
          $ref: '#/components/schemas/RoleChange'

    RoleChangeListResponse:
      type: object
      properties:
        role_changes:
          type: array
          items:
            $ref: '#/components/schemas/RoleChange'
        total_count:
          type: integer
          description: 总记录数

    InviteReviewerRequest:
      type: object
      required:
        - email
        - name
      properties:
        email:
          type: string
          format: email
          description: 审稿人邮箱
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 审稿人姓名
        manuscript_id:
          type: string
          format: uuid
          description: 关联稿件ID（可选）
          nullable: true

    InviteReviewerResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 邀请是否发送成功
        message:
          type: string
          description: 操作结果消息
        user_id:
          type: string
          format: uuid
          description: 创建的临时审稿人用户ID
        invitation_sent:
          type: boolean
          description: 邀请邮件是否已发送

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: 当前页码
        per_page:
          type: integer
          description: 每页记录数
        total_pages:
          type: integer
          description: 总页数
        total_items:
          type: integer
          description: 总记录数
        has_next:
          type: boolean
          description: 是否有下一页
        has_prev:
          type: boolean
          description: 是否有上一页

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: 错误类型
        message:
          type: string
          description: 错误消息
        details:
          type: object
          description: 错误详情（可选）
          additionalProperties: true
          nullable: true
        timestamp:
          type: string
          format: date-time
          description: 错误发生时间