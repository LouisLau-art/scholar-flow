# Feature Specification: GAP-P0-03 Internal Collaboration Enhancement

**Feature Branch**: `045-internal-collaboration-enhancement`  
**Created**: 2026-02-09  
**Status**: Draft  
**Input**: User description: "继续（按 GAP 清单推进 GAP-P0-03：@mentions、内部任务、SLA 逾期预警）"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Notebook @提及协作 (Priority: P1)

作为编辑团队成员（ME/AE/EIC/Admin），我希望在稿件内部 Notebook 里通过 `@同事` 快速点名协作对象，让被提及的人及时收到提醒并进入同一稿件上下文处理。

**Why this priority**: 当前内部评论可写不可“点名触达”，导致协作响应依赖人工转发，是最直接影响处理时效的瓶颈。

**Independent Test**: 在任意稿件中新增一条包含 `@用户名` 的内部评论，验证被提及人收到站内提醒、可跳转到对应稿件、评论内容保留可追溯。

**Acceptance Scenarios**:

1. **Given** 内部成员在稿件 Notebook 发布包含有效提及对象的评论，**When** 评论提交成功，**Then** 每位被提及成员都收到一次站内提醒并可定位到该稿件。
2. **Given** 评论里提及了不存在或不可用的对象，**When** 用户尝试提交，**Then** 系统给出明确提示并阻止无效提及落库。
3. **Given** 同一评论重复提及同一对象，**When** 评论保存，**Then** 系统仅产生一条有效提醒，避免通知轰炸。

---

### User Story 2 - 内部任务化协作 (Priority: P1)

作为编辑负责人，我希望把稿件协作事项转成可指派、可截止、可跟踪状态的内部任务，避免“只有讨论没有执行”。

**Why this priority**: 仅有评论无法形成责任闭环，任务化是确保事项按时推进的核心能力。

**Independent Test**: 在稿件详情新增内部任务，设置负责人与截止时间，执行状态更新（待办->进行中->完成），验证时间线与当前状态一致且可追踪。

**Acceptance Scenarios**:

1. **Given** 编辑创建内部任务并填写负责人、截止时间和描述，**When** 保存成功，**Then** 任务出现在稿件任务列表且带有清晰状态与责任人。
2. **Given** 任务负责人更新任务状态，**When** 状态变化发生，**Then** 系统记录变更轨迹并更新最近处理时间。
3. **Given** 非负责人尝试修改受限字段，**When** 提交修改，**Then** 系统按权限规则拒绝并保留原任务信息。

---

### User Story 3 - 逾期风险可视化与筛选 (Priority: P2)

作为编辑团队管理者，我希望在 Process 列表中快速看到逾期任务风险（overdue）并可筛选，以便优先处理高风险稿件。

**Why this priority**: 前两条能力解决“创建与协作”，该故事解决“全局排程与风控”，让团队每天先处理最急稿件。

**Independent Test**: 让一批稿件任务进入逾期与未逾期两种状态，验证 Process 列表的逾期标识和筛选结果准确。

**Acceptance Scenarios**:

1. **Given** 某稿件存在未完成且已超过截止时间的内部任务，**When** 用户查看 Process 列表，**Then** 该稿件显示逾期标识。
2. **Given** 用户启用“仅看逾期”筛选，**When** 列表刷新，**Then** 只展示满足逾期条件的稿件。
3. **Given** 逾期任务被完成或截止时间被调整到未来，**When** 列表再次加载，**Then** 稿件逾期标识自动消失。

### Edge Cases

- 评论中包含多个提及对象时，部分对象可用、部分不可用，系统需明确指出失败对象并保证可用对象处理一致。
- 被提及成员已被停用或角色变更为非内部成员时，不应继续投递内部协作提醒。
- 任务截止时间被设置为过去时间时，应立即标识为逾期并提醒创建人确认。
- 任务在“完成”后被重新打开时，逾期状态需按当前截止时间重新计算。
- 当同一稿件有多条任务同时逾期时，列表需保持单稿件单标识，详情页展示逾期明细数量。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 支持在稿件内部 Notebook 中识别并保存有效的 `@内部成员` 提及关系。
- **FR-002**: 系统 MUST 在评论提交时校验被提及对象是否为可协作的内部成员。
- **FR-003**: 系统 MUST 为每个被提及成员生成可追溯的站内提醒，且同一评论对同一成员不得重复提醒。
- **FR-004**: 用户 MUST 能从提醒直接定位到对应稿件与评论上下文。
- **FR-005**: 系统 MUST 支持在稿件下创建内部任务，并要求包含任务描述、负责人、截止时间、任务状态。
- **FR-006**: 系统 MUST 支持内部任务状态流转，至少覆盖待办、进行中、已完成。
- **FR-007**: 系统 MUST 记录每次任务创建、更新、状态变化的操作者与时间，保证可审计。
- **FR-008**: 系统 MUST 对内部任务编辑能力执行权限控制，防止未授权成员修改受限信息。
- **FR-009**: 系统 MUST 在稿件详情展示任务列表，包含负责人、截止时间、状态与是否逾期。
- **FR-010**: 系统 MUST 在 Process 列表提供稿件级逾期标识，以反映该稿件是否存在逾期未完成任务。
- **FR-011**: 系统 MUST 支持 Process 列表按“仅逾期稿件”进行筛选。
- **FR-012**: 系统 MUST 在任务状态或截止时间变化后实时更新逾期判定结果。
- **FR-013**: 系统 MUST 保证提及与任务记录在稿件维度可被检索与回溯，用于后续复盘。
- **FR-014**: 系统 MUST 对异常输入（空提及、无负责人任务、无截止时间任务）提供明确且可理解的反馈。

### Key Entities *(include if feature involves data)*

- **Internal Mention**: 表示某条内部评论中对内部成员的提及关系，包含评论标识、提及人、被提及人、创建时间。
- **Mention Notification**: 表示因提及触发的站内提醒，包含接收人、目标稿件、来源评论、阅读状态、触发时间。
- **Internal Task Item**: 表示稿件内部执行事项，包含标题/描述、负责人、截止时间、当前状态、优先级、创建与更新时间。
- **Task Activity Log**: 表示任务生命周期中的关键动作记录，包含动作类型、操作者、变更前后值、发生时间。
- **Manuscript SLA Snapshot**: 表示稿件是否存在逾期任务及逾期数量，用于 Process 列表聚合展示和筛选。

### Assumptions

- 现有内部 Notebook 与通知中心能力可继续复用，并允许新增协作类通知类型。
- 内部成员身份与角色信息已可用于权限校验和提及对象过滤。
- 逾期定义采用统一规则：当前时间超过截止时间且任务未完成即视为逾期。

### Dependencies

- 依赖现有稿件详情内部 Notebook 模块作为提及入口。
- 依赖现有通知中心作为提及提醒承载通道。
- 依赖现有 Process 列表筛选能力扩展逾期维度。
- 依赖现有审计能力记录任务与提及关键动作。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% 以上包含有效提及的内部评论可在 1 分钟内让被提及成员看到站内提醒。
- **SC-002**: 100% 内部任务都具备负责人、截止时间和明确状态，避免“无主任务”。
- **SC-003**: Process 列表逾期标识准确率达到 100%（与稿件任务实际状态一致）。
- **SC-004**: 编辑团队在发布后两个迭代内，因“协作未触达”导致的内部补沟通反馈数量下降 50%。
- **SC-005**: 在验收脚本中，`@提及 -> 任务创建 -> 逾期筛选` 主路径连续两次执行通过率达到 100%。
