openapi: 3.0.3
info:
  title: Pre-check Role Hardening API
  version: 1.0.0
  description: |
    GAP-P0-01：补齐 ME -> AE -> EIC 预审工作流。
    本合同覆盖预审队列、分派、技术质检、学术初审，以及 process/detail 的可视化字段。

servers:
  - url: /api/v1

security:
  - BearerAuth: []

paths:
  /editor/intake:
    get:
      summary: 获取 ME Intake 队列
      description: 返回 `status=pre_check` 且 `pre_check_status=intake`（含 null 兼容）的稿件列表。
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Queue items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PrecheckQueueItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /editor/manuscripts/{id}/assign-ae:
    post:
      summary: ME 分派/重分派 AE
      parameters:
        - $ref: '#/components/parameters/ManuscriptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignAERequest'
      responses:
        '200':
          description: Assignment accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionAck'
              examples:
                assigned:
                  value:
                    message: AE assigned successfully
                    data:
                      id: "11111111-1111-1111-1111-111111111111"
                      status: pre_check
                      pre_check_status: technical
                      assistant_editor_id: "22222222-2222-2222-2222-222222222222"
                      updated_at: "2026-02-09T11:15:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'

  /editor/workspace:
    get:
      summary: 获取 AE Technical Workspace
      description: 返回当前 AE 被分配的 `pre_check_status=technical` 稿件。
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Queue items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PrecheckQueueItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /editor/manuscripts/{id}/submit-check:
    post:
      summary: AE 提交技术质检
      description: |
        - decision=pass: technical -> academic
        - decision=revision: pre_check -> minor_revision（comment 必填）
      parameters:
        - $ref: '#/components/parameters/ManuscriptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TechnicalCheckRequest'
      responses:
        '200':
          description: Technical check submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionAck'
              examples:
                pass:
                  value:
                    message: Technical check submitted
                    data:
                      id: "11111111-1111-1111-1111-111111111111"
                      status: pre_check
                      pre_check_status: academic
                      assistant_editor_id: "22222222-2222-2222-2222-222222222222"
                      updated_at: "2026-02-09T11:35:00Z"
                revision:
                  value:
                    message: Technical check submitted
                    data:
                      id: "11111111-1111-1111-1111-111111111111"
                      status: minor_revision
                      pre_check_status: null
                      assistant_editor_id: "22222222-2222-2222-2222-222222222222"
                      updated_at: "2026-02-09T11:35:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'

  /editor/academic:
    get:
      summary: 获取 EIC Academic 队列
      description: 返回 `status=pre_check` 且 `pre_check_status=academic` 稿件。
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Queue items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PrecheckQueueItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /editor/manuscripts/{id}/academic-check:
    post:
      summary: EIC 提交学术初审
      description: |
        - decision=review: pre_check -> under_review
        - decision=decision_phase: pre_check -> decision
      parameters:
        - $ref: '#/components/parameters/ManuscriptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcademicCheckRequest'
      responses:
        '200':
          description: Academic check submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionAck'
              examples:
                to_review:
                  value:
                    message: Academic check submitted
                    data:
                      id: "11111111-1111-1111-1111-111111111111"
                      status: under_review
                      pre_check_status: null
                      assistant_editor_id: "22222222-2222-2222-2222-222222222222"
                      updated_at: "2026-02-09T11:50:00Z"
                to_decision:
                  value:
                    message: Academic check submitted
                    data:
                      id: "11111111-1111-1111-1111-111111111111"
                      status: decision
                      pre_check_status: null
                      assistant_editor_id: "22222222-2222-2222-2222-222222222222"
                      updated_at: "2026-02-09T11:50:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'

  /editor/manuscripts/process:
    get:
      summary: 获取 Process 列表（含预审可视化字段）
      parameters:
        - name: q
          in: query
          schema:
            type: string
            maxLength: 100
        - name: journal_id
          in: query
          schema:
            type: string
            format: uuid
        - name: owner_id
          in: query
          schema:
            type: string
            format: uuid
        - name: editor_id
          in: query
          schema:
            type: string
            format: uuid
        - name: manuscript_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
      responses:
        '200':
          description: Process rows
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProcessRow'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'

  /editor/manuscripts/{id}:
    get:
      summary: 获取编辑稿件详情（含预审时间线）
      parameters:
        - $ref: '#/components/parameters/ManuscriptId'
      responses:
        '200':
          description: Manuscript detail
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/ManuscriptDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /editor/manuscripts/{id}/audit-logs:
    get:
      summary: 获取稿件审计日志
      parameters:
        - $ref: '#/components/parameters/ManuscriptId'
      responses:
        '200':
          description: Audit logs
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PrecheckTimelineEvent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ManuscriptId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    Page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    PageSize:
      name: page_size
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    Unauthorized:
      description: Missing/invalid bearer token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            token_missing:
              value:
                detail: Not authenticated
    Forbidden:
      description: Role not allowed for this operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            role_blocked:
              value:
                detail: Operation requires role: managing_editor
    NotFound:
      description: Target manuscript not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            manuscript_missing:
              value:
                detail: Manuscript not found
    BadRequest:
      description: Invalid state transition or request payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            reject_gate:
              value:
                detail: Reject is only allowed in decision/decision_done stage
    Conflict:
      description: Concurrent update conflict / stale state
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            stale_stage:
              value:
                detail: Technical check conflict: manuscript state changed
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            revision_without_comment:
              value:
                detail: comment is required for revision

  schemas:
    ErrorResponse:
      type: object
      properties:
        detail:
          type: string

    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        full_name:
          type: string
          nullable: true
        email:
          type: string
          nullable: true

    PrecheckQueueItem:
      type: object
      required:
        - id
        - status
        - pre_check_status
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          nullable: true
        status:
          type: string
        pre_check_status:
          type: string
          enum: [intake, technical, academic]
        assistant_editor_id:
          type: string
          format: uuid
          nullable: true
        current_role:
          type: string
          enum: [managing_editor, assistant_editor, editor_in_chief]
        current_assignee:
          allOf:
            - $ref: '#/components/schemas/UserSummary'
          nullable: true
        assigned_at:
          type: string
          format: date-time
          nullable: true
        technical_completed_at:
          type: string
          format: date-time
          nullable: true
        academic_completed_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true

    AssignAERequest:
      type: object
      required: [ae_id]
      properties:
        ae_id:
          type: string
          format: uuid
        idempotency_key:
          type: string
          maxLength: 64
          nullable: true
          description: Client supplied key for retries (for audit visibility only).

    TechnicalCheckRequest:
      type: object
      required: [decision]
      properties:
        decision:
          type: string
          enum: [pass, revision]
        comment:
          type: string
          maxLength: 2000
          nullable: true
        idempotency_key:
          type: string
          maxLength: 64
          nullable: true
          description: Optional idempotency marker recorded into transition payload.

    AcademicCheckRequest:
      type: object
      required: [decision]
      properties:
        decision:
          type: string
          enum: [review, decision_phase]
        comment:
          type: string
          maxLength: 2000
          nullable: true
        idempotency_key:
          type: string
          maxLength: 64
          nullable: true
          description: Optional idempotency marker recorded into transition payload.

    ActionResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
        pre_check_status:
          type: string
          nullable: true
        assistant_editor_id:
          type: string
          format: uuid
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true

    ActionAck:
      type: object
      required: [message]
      properties:
        message:
          type: string
        data:
          $ref: '#/components/schemas/ActionResult'

    ProcessRow:
      type: object
      required: [id, status]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          nullable: true
        status:
          type: string
        pre_check_status:
          type: string
          nullable: true
        assistant_editor_id:
          type: string
          format: uuid
          nullable: true
        current_role:
          type: string
          nullable: true
        current_assignee:
          allOf:
            - $ref: '#/components/schemas/UserSummary'
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true

    PrecheckTimelineEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        manuscript_id:
          type: string
          format: uuid
        from_status:
          type: string
          nullable: true
        to_status:
          type: string
        comment:
          type: string
          nullable: true
        changed_by:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        payload:
          type: object
          nullable: true
          properties:
            action:
              type: string
            pre_check_from:
              type: string
              nullable: true
            pre_check_to:
              type: string
              nullable: true
            assistant_editor_before:
              type: string
              format: uuid
              nullable: true
            assistant_editor_after:
              type: string
              format: uuid
              nullable: true
            decision:
              type: string
              nullable: true
            idempotency_key:
              type: string
              nullable: true

    ManuscriptDetail:
      type: object
      required: [id, status]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          nullable: true
        status:
          type: string
        pre_check_status:
          type: string
          nullable: true
        assistant_editor_id:
          type: string
          format: uuid
          nullable: true
        owner:
          allOf:
            - $ref: '#/components/schemas/UserSummary'
          nullable: true
        editor:
          allOf:
            - $ref: '#/components/schemas/UserSummary'
          nullable: true
        role_queue:
          type: object
          nullable: true
          properties:
            current_role:
              type: string
              nullable: true
            current_assignee:
              allOf:
                - $ref: '#/components/schemas/UserSummary'
              nullable: true
            assigned_at:
              type: string
              format: date-time
              nullable: true
            technical_completed_at:
              type: string
              format: date-time
              nullable: true
            academic_completed_at:
              type: string
              format: date-time
              nullable: true
        precheck_timeline:
          type: array
          items:
            $ref: '#/components/schemas/PrecheckTimelineEvent'
